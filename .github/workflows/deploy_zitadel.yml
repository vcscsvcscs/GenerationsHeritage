name: Deploy
on: 
  push:
#    branches:
#      - main
    paths:
      - 'deployment/zitadel_values.yaml'

jobs:
  deployment:
    runs-on: 'ubuntu-latest'
    steps:
    - uses: actions/checkout@v4
      name: Checkout
    - name: Deploy to Kubernetes
      uses: actions-hub/kubectl@master
      env:
        KUBE_CONFIG: ${{ secrets.KUBE_CONFIG }}
      with:
        args: apply -f deployment/certs-job.yaml
        
    - name: 'Deploy Database'
      uses: 'vimeda/helm@v1'
      with:
        release: 'database'
        repo: 'https://charts.zitadel.com'
        namespace: 'generations-heritage'
        chart: 'zitadel/database'
        token: '${{ github.token }}'
        value-files: "deployment/database_values.yaml"
      env:
        KUBECONFIG_FILE: '${{ secrets.KUBECONFIG }}'

    - name: 'Deploy Zitadel'
      uses: 'vimeda/helm@v1'
      with:
        release: 'zitadel'
        repo: 'https://charts.zitadel.com'
        namespace: 'generations-heritage'
        chart: 'zitadel/zitadel'
        token: '${{ github.token }}'
        value-files: "deployment/zitadel_values.yaml"
      env:
        KUBECONFIG_FILE: '${{ secrets.KUBECONFIG }}'